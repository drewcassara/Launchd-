<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Launchd</title>
<style>
  body { font-family: Arial, sans-serif; background: rgb(255, 255, 255); margin: 40px; }
  h1 { text-align: left; margin-bottom:5px; }
  #headerInfo { font-size: 0.9em; margin-bottom: 20px; }

  #topContainer { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
  #searchInput { width: 50%; padding: 10px, 10px; font-size: 1em; border-radius: 8px; border: 1px solid #ccc; }
  #dropdownFormArea { width: 25%; position: relative; }
  #toggleFormBtn {
    width: 50%;
    padding: 8px 10px;
    background: #d6ccf5;
    color: #2e1a70;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 1em;
    text-align: center;
    box-shadow: 0 3px 8px rgba(0,0,0,0.12);
    float: right;
    font-weight: bold;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  /* larger, bold plus sign */
  .plus {
    font-size: 1.6em;
    line-height: 1;
    font-weight: 900;
    display: inline-block;
    vertical-align: middle;
  }

  #patientFormWrapper {
    position: absolute;
    top: 50px;
    left: 0;
    width: 100%;
    background: #f4e8e8;
    border-radius: 12px;
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.7);
    padding: 15px;
    opacity: 0;
    max-height: 0;
    overflow: hidden;
    pointer-events: none;
    transition: max-height 0.45s cubic-bezier(.2,.9,.2,1), opacity 0.35s ease;
    z-index: 9999;
  }
  #patientFormWrapper.active { opacity: 1; max-height: 1000px; pointer-events: auto; }

  #patientFormContainer input,
  #patientFormContainer button { padding: 8px; width: 100%; margin-bottom: 12px; border-radius: 6px; border: none; font-size: 1em; }
  #patientFormContainer button { background: #73ff63; color: white; font-weight: bold; cursor: pointer; }
  #patientFormContainer button:hover { background: #08c708; }

  .gender-group { display: flex; align-items: center; gap: 20px; margin-bottom: 12px; }
  .gender-group label { font-weight: bold; display: flex; align-items: center; gap: 8px; }
  .gender-group input[type="radio"] { width: 20px; height: 20px; cursor: pointer; }

  .unit-section { margin-bottom: 25px; }
  .unit-title { background: #cce6ff; padding: 10px 15px; font-size: 1.2em; font-weight: bold; border-radius: 12px; }
  .unit-container { background: #cce6ff; border-radius: 12px; padding: 15px; margin-top: 8px; }

  .patient-card { background: #ebe9f2; border-radius: 12px; border: 2px solid #b5a3e2; padding: 15px 18px; margin: 12px 0; box-shadow: 0 5px 15px rgba(90, 62, 160, 0.5); color: #2e1a70; }
  .patient-card label { font-weight: bold; }
  .top-line { display: flex; justify-content: space-between; flex-wrap: wrap; font-size: 0.95em; margin-bottom: 10px; }
  .top-item { flex: 1; text-align: center; min-width: 100px; }
  .hx-section, .disposition-section { margin-top: 8px; background: rgba(90,62,160,0.06); padding: 10px; border-radius: 8px; white-space: pre-wrap; }
  .card-actions { text-align: right; margin-top: 8px; }
  .action-btn { padding: 6px 14px; border: none; border-radius: 8px; cursor: pointer; margin-left: 8px; font-weight: bold; font-size: 0.9em; }
  .edit { background-color: #f0ad4e; color: white; }
  .delete { background-color: #d9534f; color: white; }
  .save { background-color: #5cb85c; color: white; }
  .cancel { background-color: #777; color: white; }
  .patient-card input, .patient-card textarea { font-family: Arial, sans-serif; font-size: 1em; width: 100%; box-sizing: border-box; border-radius: 6px; border: 1px solid #999; padding: 6px 8px; margin-bottom: 8px; resize: vertical; color: #2e1a70; }
  .patient-card textarea { min-height: 90px; }
  .date-wrapper { display:flex; align-items:center; gap:8px; margin-bottom:12px; }
  .date-wrapper label { min-width:120px; font-weight:bold; }
  .date-wrapper input { flex:1; }
  .age-display { font-weight: bold; color: #00cc00; margin-left: 6px; }
  /* pastel theme for action buttons to match site */
.edit {
  background-color: #EBDCF7; /* pastel lavender */
  color: #2e1a70; /* site accent dark purple for contrast */
  box-shadow: none;
}
.edit:hover { background-color: #E2CFF3; }
.delete {
  background-color: #FFD7DA; /* pastel pink */
  color: #7a1a2a; /* darker pink/maroon for contrast */
}
.delete:hover { background-color: #FFC0C4; }

  /* Add Note button pastel variant */
  .add-note {
    background-color: #E6F7E6; /* pastel mint */
    color: #145A20; /* darker green for contrast */
  }
  .add-note:hover { background-color: #D7F0D7; }

  /* single-line note row: date label + input/text */
  .note-line { display:flex; align-items:center; gap:8px; margin-top:8px; }
  .note-date {
    font-weight:bold;
    min-width:110px;
    /* color:#444; */
    color: #2e1a70; /* match LAST NAME font color */
  }
  .note-input {
    flex: 1;
    font-family: Arial, sans-serif;
    font-size: 1em;
    width: 100%;
    min-height: 60px;
    padding: 10px 12px;
    border-radius: 6px;
    border: 1px solid #b5a3e2;  /* match patient card border color */
    margin-bottom: 8px;
    resize: vertical;
    color: #2e1a70;
    box-sizing: border-box;
    white-space: pre-wrap;
    overflow-wrap: break-word;
    word-break: break-word;
    /* Make input look like textarea if JS hasn't swapped it yet */
  }
  .note-input:focus {
    outline: none;
    border-color: #b5a3e2;
    box-shadow: 0 0 0 1px #b5a3e2;
  }
  .note-text { flex:1; padding:6px 8px; background: rgba(255,255,255,0.3); border-radius:6px; color:#2e1a70; white-space:pre-wrap; }

  /* big bold pastel red delete button for notes */
  .note-delete {
    background-color: #FFD7DA; /* pastel red */
    color: #7a1a2a;
    font-weight: 900;
    border: none;
    border-radius: 8px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 1.1em;
    box-shadow: none;
  }
  .note-delete:hover { background-color: #FFC0C4; }

  .edit-hx {
    padding-top: 1.5em; /* Add padding to push text to the second line */
  }
  /* ...existing code... */
</style>
</head>
<body>

<h1>StepDown v1.1</h1>
<div id="headerInfo"></div>

<div id="topContainer">
  <input type="text" id="searchInput" placeholder="Search by Name or Room #..." />
  <div id="dropdownFormArea">
    <button id="toggleFormBtn" type="button"><span class="plus">+</span> Patient</button>
    <div id="patientFormWrapper" aria-hidden="true">
      <div id="patientFormContainer">
        <form id="patientForm" autocomplete="off">
          <input type="text" id="lastName" placeholder="Last Name" required />
          <input type="text" id="firstName" placeholder="First Name" required />
          <div class="date-wrapper">
            <label for="dob">DOB:</label>
            <input type="date" id="dob" />
            <span class="age-display" id="ageDisplayForm"></span>
          </div>
          <input type="text" id="room" placeholder="Room # (e.g., 1158B)" required />
          <div class="date-wrapper">
            <label for="admitDate">Date of Admission:</label>
            <input type="date" id="admitDate" />
          </div>
          <div class="gender-group">
            <label><input type="radio" name="gender" value="Male" checked /> Male</label>
            <label><input type="radio" name="gender" value="Female" /> Female</label>
          </div>
          <input type="text" id="insurance" placeholder="Insurance" />
          <button type="submit">Add Patient</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div id="unit1" class="unit-section"><div class="unit-title">Unit 1</div><div class="unit-container"></div></div>
<div id="unit2" class="unit-section"><div class="unit-title">Unit 2</div><div class="unit-container"></div></div>
<div id="unit3" class="unit-section"><div class="unit-title">Unit 3</div><div class="unit-container"></div></div>

<script>
let patients = JSON.parse(localStorage.getItem('patients')) || [];

const form = document.getElementById('patientForm');
const searchInput = document.getElementById('searchInput');
const toggleBtn = document.getElementById('toggleFormBtn');
const formWrapper = document.getElementById('patientFormWrapper');
const headerInfo = document.getElementById('headerInfo');
const ageDisplayForm = document.getElementById('ageDisplayForm');
const admitDateInput = document.getElementById('admitDate');
admitDateInput.value = new Date().toISOString().split('T')[0];

// Toggle form
toggleBtn.addEventListener('click', ()=>{
  formWrapper.classList.toggle('active');
  formWrapper.setAttribute('aria-hidden', !formWrapper.classList.contains('active'));
  if(formWrapper.classList.contains('active')) {
    form.reset();
    ageDisplayForm.textContent='';
    admitDateInput.value = new Date().toISOString().split('T')[0];
  }
});

// Close the form when clicking outside of it (but not when clicking the toggle button)
document.addEventListener('click', (e) => {
  if(!formWrapper.classList.contains('active')) return;
  if(formWrapper.contains(e.target) || toggleBtn.contains(e.target)) return;
  formWrapper.classList.remove('active');
  formWrapper.setAttribute('aria-hidden','true');
});

// Optional: close with Escape key
document.addEventListener('keydown', (e) => {
  if(e.key === 'Escape' && formWrapper.classList.contains('active')) {
    formWrapper.classList.remove('active');
    formWrapper.setAttribute('aria-hidden','true');
  }
});

// Live age display in Add Patient form
document.getElementById('dob').addEventListener('input', ()=>{
  const dob = document.getElementById('dob').value;
  if(dob){
    const age = Math.floor((Date.now() - new Date(dob).getTime()) / (1000*60*60*24*365.25));
    ageDisplayForm.textContent = age ? `(${age}yo)` : '';
  } else ageDisplayForm.textContent='';
});

// Add patient
form.addEventListener('submit', e=>{
  e.preventDefault();
  const gender = (document.querySelector('input[name="gender"]:checked')||{}).value||'';
  const patient = {
    lastName: document.getElementById('lastName').value.trim().toUpperCase(),
    firstName: document.getElementById('firstName').value.trim().toUpperCase(),
    dob: document.getElementById('dob').value,
    room: document.getElementById('room').value.trim().toUpperCase(),
    admitDate: document.getElementById('admitDate').value,
    gender: gender.toUpperCase(),
    insurance: document.getElementById('insurance').value.trim().toUpperCase(),
    hx: '', disposition:'', unit:'', notes: [] // <-- added notes array
  };
  if(!patient.lastName||!patient.firstName||!patient.room){ alert('Last Name, First Name, and Room are required.'); return; }
  patient.unit = getUnit(patient.room);
  patients.push(patient);
  patients.sort((a,b)=>normalizeRoom(a.room)-normalizeRoom(b.room));
  savePatients(); renderAll();
  form.reset(); ageDisplayForm.textContent=''; admitDateInput.value=new Date().toISOString().split('T')[0];
  formWrapper.classList.remove('active'); formWrapper.setAttribute('aria-hidden','true');
});

searchInput.addEventListener('input', renderAll);

function savePatients(){ localStorage.setItem('patients', JSON.stringify(patients)); }
function normalizeRoom(room){ const num=parseInt((room||'').replace(/\D/g,''))||0; const letter=(String(room||'').match(/[A-Z]$/i)||[''])[0].toUpperCase(); const offset=letter==='A'?0.1:(letter==='B'?0.2:0); return num+offset; }
function getUnit(room){ if(!room) return "Unassigned"; const num=parseInt(room.replace(/\D/g,''),10); if(isNaN(num)) return "Unassigned"; if(num>=1161&&num<=1183)return"Unit 1"; if(num>=1147&&num<=1163)return"Unit 2"; if(num>=1034&&num<=1050)return"Unit 3"; return"Unassigned"; }
function formatShortDate(dateStr){ if(!dateStr) return ''; const d=new Date(dateStr); if(isNaN(d)) return dateStr; const mm=d.getMonth()+1; const dd=d.getDate(); const yy=String(d.getFullYear()).slice(-2); return `${mm}/${dd}/${yy}`; }
function escapeHtml(str){ if(!str && str!==0) return ''; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"); }

function renderAll(){
  renderUnit("Unit 1",document.querySelector("#unit1 .unit-container"));
  renderUnit("Unit 2",document.querySelector("#unit2 .unit-container"));
  renderUnit("Unit 3",document.querySelector("#unit3 .unit-container"));
  headerInfo.textContent=`As of ${formatShortDate(new Date().toLocaleDateString('en-US'))} You Have ${patients.length} Patients`;
}

// Render patients in a unit
function renderUnit(unitName, container){
  container.innerHTML='';
  const query = searchInput.value.trim().toLowerCase();
  patients.filter(p=>p.unit===unitName && (p.firstName.toLowerCase().includes(query) || p.lastName.toLowerCase().includes(query) || p.room.toLowerCase().includes(query)))
    .forEach((p,idx)=>{
      const card = document.createElement('div'); card.className='patient-card';
      const age = p.dob?Math.floor((Date.now()-new Date(p.dob).getTime())/(1000*60*60*24*365.25)):'',
      // build notes HTML: show the date label only once per calendar day (per patient)
      seenDates = new Set();
      const notesHtml = (p.notes||[]).map((note,i)=>{
        const d = new Date(note.created||new Date().toISOString());
        const ymd = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        const showDate = !seenDates.has(ymd);
        if(showDate) seenDates.add(ymd);
        let weekday = d.toLocaleDateString('en-US',{weekday:'long'});
        weekday = weekday.toUpperCase();
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const dd = String(d.getDate()).padStart(2,'0');
        const dateLabel = showDate ? `${weekday}-${mm}/${dd}` : '';
        const createdAttr = escapeHtml(note.created||'');
        const text = (note.text||'').trim();
        const xBtn = p.editing ? `<button class="note-delete" data-idx="${i}" aria-label="Delete note">X</button>` : '';
        if(text){
          // saved note as text (include data-idx for click-to-edit)
          return `<div class="note-line"><span class="note-date">${escapeHtml(dateLabel)}</span><div class="note-text" data-idx="${i}">${escapeHtml(text)}</div>${xBtn}</div>`;
        } else {
          // empty note -> input for editing
          return `<div class="note-line"><span class="note-date">${escapeHtml(dateLabel)}</span><input class="note-input" data-idx="${i}" data-created="${createdAttr}" value="${escapeHtml(note.text||'')}" />${xBtn}</div>`;
        }
      }).join('');

      if(p.editing){
        card.innerHTML=`<div class="top-line">
          <div class="top-item"><label>ROOM #:</label> <input type="text" class="edit-room" value="${escapeHtml(p.room)}" /></div>
          <div class="top-item"><label>ADMIT DATE:</label> <input type="date" class="edit-admitDate" value="${p.admitDate||''}" /></div>
          <div class="top-item"><label>GENDER:</label>
            <div class="gender-group">
              <label><input type="radio" name="edit-gender-${idx}" value="MALE" ${p.gender==='MALE'?'checked':''}/> Male</label>
              <label><input type="radio" name="edit-gender-${idx}" value="FEMALE" ${p.gender==='FEMALE'?'checked':''}/> Female</label>
            </div>
          </div>
          <div class="top-item"><label>INSURANCE:</label> <input type="text" class="edit-insurance" value="${escapeHtml(p.insurance||'')}" /></div>
        </div>
        <div><label>LAST NAME:</label> <input type="text" class="edit-lastName" value="${escapeHtml(p.lastName)}" /></div>
        <div><label>FIRST NAME:</label> <input type="text" class="edit-firstName" value="${escapeHtml(p.firstName)}" /></div>
        <div><label>DOB:</label> <input type="date" class="edit-dob" value="${p.dob||''}" /><span class="age-display">${age?`(${age}yo)`:''}</span></div>
        <div class="hx-section"><label>HX OF PRESENT ILLNESS:</label> <textarea class="edit-hx">${escapeHtml(p.hx||'')}</textarea></div>
        <div class="disposition-section"><label>DISPOSITION:</label> <textarea class="edit-disposition">${escapeHtml(p.disposition||'')}</textarea></div>
        ${notesHtml}
        <div class="card-left-actions"><button class="action-btn add-note">Add Note</button></div>
        <div class="card-actions"><button class="action-btn save">Save</button><button class="action-btn cancel">Cancel</button></div>`;
        card.querySelector('.save').onclick=()=>{
          p.lastName=card.querySelector('.edit-lastName').value.trim().toUpperCase();
          p.firstName=card.querySelector('.edit-firstName').value.trim().toUpperCase();
          p.dob=card.querySelector('.edit-dob').value;
          p.room=card.querySelector('.edit-room').value.trim().toUpperCase();
          p.admitDate=card.querySelector('.edit-admitDate').value;
          p.gender=(card.querySelector(`input[name="edit-gender-${idx}"]:checked`)||{}).value;
          p.insurance=card.querySelector('.edit-insurance').value.trim().toUpperCase();
          p.hx=card.querySelector('.edit-hx').value.trim() || "No additional information provided.";
          p.disposition=card.querySelector('.edit-disposition').value.trim() || "No disposition details available.";
          p.unit=getUnit(p.room);
          p.editing=false;
          patients.sort((a,b)=>normalizeRoom(a.room)-normalizeRoom(b.room));
          savePatients(); renderAll();
        };
        card.querySelector('.cancel').onclick=()=>{ p.editing=false; renderAll(); };

        // Add Note handler for edit mode
        card.querySelector('.add-note').onclick=()=>{
          p.notes = p.notes || [];
          const created = new Date().toISOString();
          p.notes.push({ text:'', created });
          savePatients(); renderAll();
          // focus the newly created input after render
          setTimeout(()=>{ const inp = document.querySelector(`input[data-created="${created}"]`); if(inp) inp.focus(); }, 0);
        };
      } else {
        card.innerHTML=`<div class="top-line">
          <div class="top-item"><label>ROOM #:</label> ${escapeHtml(p.room)}</div>
          <div class="top-item"><label>ADMIT DATE:</label> ${formatShortDate(p.admitDate)}</div>
          <div class="top-item"><label>GENDER:</label> ${escapeHtml(p.gender)}</div>
          <div class="top-item"><label>INSURANCE:</label> ${escapeHtml(p.insurance)}</div>
        </div>
        <div><label>LAST NAME:</label> ${escapeHtml(p.lastName)}</div>
        <div><label>FIRST NAME:</label> ${escapeHtml(p.firstName)}</div>
        <div><label>DOB:</label> ${formatShortDate(p.dob)}${age?` <span class="age-display">(${age}yo)</span>`:''}</div>
        <div class="hx-section"><label>HX OF PRESENT ILLNESS:</label> ${escapeHtml(p.hx||'No additional information provided.')}</div>
        <div class="disposition-section"><label>DISPOSITION:</label> ${escapeHtml(p.disposition||'No disposition details available.')}</div>
        ${notesHtml}
        <div class="card-left-actions"><button class="action-btn add-note">Add Note</button></div>
        <div class="card-actions"><button class="action-btn edit">Edit</button><button class="action-btn delete">Delete</button></div>`;
        card.querySelector('.edit').onclick=()=>{ p.editing=true; renderAll(); };
        card.querySelector('.delete').onclick=()=>{ if(confirm(`Delete patient ${p.firstName} ${p.lastName}?`)){ patients.splice(idx,1); savePatients(); renderAll(); } };

        // Add Note handler for view mode
        card.querySelector('.add-note').onclick=()=>{
          p.notes = p.notes || [];
          const created = new Date().toISOString();
          p.notes.push({ text:'', created });
          savePatients(); renderAll();
          setTimeout(()=>{ const inp = document.querySelector(`input[data-created="${created}"]`); if(inp) inp.focus(); }, 0);
        };
      }

      container.appendChild(card);

      // save note on blur / Enter; always use textarea for note input, auto-expand as you type
      card.querySelectorAll('.note-input').forEach(inp=>{
        // Always use textarea for note input
        if (inp.tagName !== 'TEXTAREA') {
          const ni = parseInt(inp.dataset.idx,10);
          const ta = document.createElement('textarea');
          ta.className = 'note-input';
          ta.dataset.idx = inp.dataset.idx;
          ta.value = inp.value;
          ta.style.minHeight = '60px';
          ta.style.resize = 'vertical';
          ta.style.overflowWrap = 'break-word';
          ta.style.wordBreak = 'break-word';
          inp.replaceWith(ta);
          ta.focus();
          ta.setSelectionRange(ta.value.length, ta.value.length);
          // Auto-expand as you type
          ta.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight+2) + 'px';
          });
          ta.dispatchEvent(new Event('input'));
          // Save on blur
          ta.addEventListener('blur', ()=>{
            p.notes = p.notes || [];
            if(Number.isFinite(ni) && p.notes[ni]){
              p.notes[ni].text = ta.value.trim();
              savePatients();
              if(p.notes[ni].text) renderAll();
            }
          });
        }
      });

      // allow clicking saved note text to edit it inline
      card.querySelectorAll('.note-text').forEach(textEl=>{
        textEl.style.cursor = 'text';
        textEl.addEventListener('click', ()=>{
          const ni = parseInt(textEl.dataset.idx,10);
          p.notes = p.notes || [];
          if(!Number.isFinite(ni) || !p.notes[ni]) return;
          const ta = document.createElement('textarea');
          ta.className = 'note-input';
          ta.dataset.idx = ni;
          ta.value = p.notes[ni].text || '';
          ta.style.minHeight = '60px';
          ta.style.resize = 'vertical';
          ta.style.overflowWrap = 'break-word';
          ta.style.wordBreak = 'break-word';
          textEl.replaceWith(ta);
          ta.focus();
          ta.setSelectionRange(ta.value.length, ta.value.length);
          // Auto-expand as you type
          ta.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight+2) + 'px';
          });
          ta.dispatchEvent(new Event('input'));
          ta.addEventListener('blur', ()=>{
            p.notes[ni].text = ta.value.trim();
            savePatients();
            renderAll();
          });
        });
      });

      // attach delete handlers for each note's "X" button (works for both input and text states)
      card.querySelectorAll('.note-delete').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const ni = parseInt(btn.dataset.idx,10);
          p.notes = p.notes || [];
          if(Number.isFinite(ni) && p.notes[ni]){
            p.notes.splice(ni,1);
            savePatients();
            renderAll();
          }
        });
      });

    });
}

renderAll();
</script>
</body>
</html>

